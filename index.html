<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hidden Maze ‚Äî Multiplayer (Local)</title>
<style>
:root{
  --cell-size:36px; --wall-color:#111; --path-color:#eee;
  --fog-color:#444; --player-you-color:#1976d2;
  --exit-color:#2e7d32; --available-color:#f9d835;
  --other-player-color:#e91e63;
}
body{
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  margin:0; padding:16px; color:#111;
  display:flex; flex-direction:column; align-items:center;
  background:#fafafa;
}
.screen { width:100%; max-width:1000px; }
.hidden { display:none !important; }

/* Auth & Home */
.auth-screen { text-align:center; padding:40px 20px; }
.auth-screen input {
  padding:12px; width:100%; max-width:300px; font-size:1rem;
  border:2px solid #ccc; border-radius:8px; margin:8px 0;
}
.auth-screen button {
  margin:10px 6px; padding:12px 24px; font-size:1.1rem; font-weight:600;
  border:none; border-radius:8px; color:white; cursor:pointer;
  background:#1976d2;
}
.auth-screen button.secondary { background:#757575; }
.error { color:#d32f2f; margin-top:12px; min-height:20px; }

#homeScreen { text-align:center; padding:30px 20px; }
.home-btn {
  display:inline-block; margin:10px;
  padding:14px 32px; font-size:1.2rem; font-weight:600;
  border:none; border-radius:10px; color:white; cursor:pointer;
  background:#1976d2;
}
.home-btn.join { background:#d32f2f; }
.home-btn.delete { background:#f44336; }
.home-btn.leave { background:#9c27b0; }
.game-input { padding:12px; font-size:1.1rem; width:220px; text-align:center; border:2px solid #ccc; border-radius:8px; }

/* Game UI */
#gameHeader {
  width:100%; max-width:1000px;
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:12px;
}
#gameTitle {
  font-size:1.3rem; font-weight:bold;
}
#playerInfo {
  font-size:1.1rem; color:#1976d2;
}
#gameScreen {
  display:flex; gap:24px; align-items:flex-start;
  width:100%;
}
.left-info {
  width:220px;
  display:flex; flex-direction:column; gap:12px;
}
.board {
  display:grid; gap:2px; background:#333;
  padding:6px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.15);
  margin-top:30px;
}
.cell {
  width:var(--cell-size); height:var(--cell-size);
  display:flex; align-items:center; justify-content:center;
  font-size:14px; user-select:none; border-radius:4px; box-sizing:border-box;
}
.wall { background: var(--wall-color); }
.path { background: var(--path-color); }
.available { background: var(--available-color); }
.player-you {
  width:20px; height:20px; border-radius:50%;
  display:inline-block; box-shadow:0 2px 6px rgba(0,0,0,0.35);
  background: var(--player-you-color);
}
.player-other {
  width:16px; height:16px; border-radius:50%;
  display:inline-block; box-shadow:0 1px 3px rgba(0,0,0,0.4);
  background: var(--other-player-color);
}
.exit {
  width:18px; height:18px; border-radius:3px;
  background:var(--exit-color); display:inline-block;
  box-shadow: inset 0 -2px 6px rgba(0,0,0,0.15);
}

.controls {
  max-width:380px; display:flex; flex-direction:column; gap:12px;
}
.panel {
  background:#fff; padding:12px; border-radius:8px;
  box-shadow:0 6px 14px rgba(0,0,0,0.06);
}
.mode-toggle {
  padding:10px; font-weight:600; border:none; border-radius:6px;
  cursor:pointer; width:100%;
}
.mode-toggle.edit { background:#ffd54f; color:#5d4037; }
.mode-toggle.play { background:#4caf50; color:white; }
.dir-btn {
  padding:8px 12px; border-radius:6px; border:1px solid #ddd;
  background:#f6f6f6; cursor:pointer; font-weight:600;
}
.dir-btn:disabled { opacity:0.45; cursor:not-allowed; }
.small { font-size:13px; color:#444; }
.footer-note { font-size:13px; color:#555; margin-top:6px; }

.library-section {
  margin:20px 0;
  text-align:left;
  padding:0 20px;
  width:100%;
  max-width:600px;
}
.library-section h3 {
  margin:15px 0 8px;
  color:#333;
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="auth-screen screen">
  <h1>üîê Hidden Maze Login</h1>
  <input type="text" id="loginUsername" placeholder="Username" autocomplete="off" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button id="btnLogin">Log In</button>
  <button id="btnCreateAccount" class="secondary">Create Account</button>
  <div id="loginError" class="error"></div>
</div>

<!-- Create Account Screen -->
<div id="createAccountScreen" class="auth-screen screen hidden">
  <h1>üÜï Create Account</h1>
  <input type="text" id="newUsername" placeholder="Choose username" autocomplete="off" />
  <input type="password" id="newPassword" placeholder="Choose password" />
  <input type="password" id="confirmPassword" placeholder="Confirm password" />
  <button id="btnSubmitCreate">Create Account</button>
  <button id="btnBackToLogin" class="secondary">‚Üê Back to Login</button>
  <div id="createError" class="error"></div>
</div>

<!-- Home Screen -->
<div id="homeScreen" class="screen hidden">
  <h1>Hidden Maze ‚Äî Welcome <span id="welcomeUser"></span></h1>
  <input type="text" id="homeGameCode" class="game-input" placeholder="Enter game code to join" maxlength="8" />
  <br>
  <button id="btnJoinHome" class="home-btn join">Join Game</button>
  
  <div style="margin:30px 0;">
    <h2>Create New Game</h2>
    <input type="text" id="gameNameInput" placeholder="Game Name" maxlength="20" style="padding:10px; width:200px; margin:10px;">
    <select id="mazeSizeSelect" style="padding:8px; margin:10px;">
      <option value="9">9x9</option>
      <option value="13">13x13</option>
      <option value="17">17x17</option>
      <option value="21" selected>21x21</option>
    </select>
    <br>
    <button id="btnCreateHome" class="home-btn">Create New Game</button>
  </div>

  <div class="library-section">
    <h3>Your Created Games</h3>
    <div id="createdGames"></div>
  </div>

  <div class="library-section">
    <h3>Joined Games</h3>
    <div id="joinedGames"></div>
  </div>

  <div style="margin-top:30px;">
    <button id="btnLogoutHome" class="home-btn" style="background:#f44336;">Logout</button>
  </div>
</div>

<!-- Game Screen -->
<div id="gameScreen" class="screen hidden">
  <div style="display:flex; gap:24px; width:100%;">
    <!-- LEFT: Info Panel -->
    <div class="left-info">
      <div>
        <div id="gameTitle">Game: <span id="gameNameDisplay">‚Äî</span></div>
        <div>Code: <span id="gameCodeDisplay">‚Äî</span></div>
        <div>Player: <span id="usernameDisplay">‚Äî</span></div>
      </div>

      <div class="panel">
        <div id="modeToggleContainer"></div>
        <div id="playControls" style="margin-top:12px;">
          <p class="small" id="controlsNote">Use arrow keys or buttons to move.</p>
          <div style="margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;">
            <button id="north" class="dir-btn">‚Üë North</button>
            <button id="south" class="dir-btn">‚Üì South</button>
            <button id="west"  class="dir-btn">‚Üê West</button>
            <button id="east"  class="dir-btn">‚Üí East</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div><strong>Game log</strong></div>
        <div id="log" class="small" style="max-height:150px; overflow:auto; margin-top:8px;"></div>
      </div>

      <button id="btnLeaveGame" class="home-btn leave" style="padding:8px; font-size:1rem;">Leave Game</button>
      <button id="btnBackToHome" class="home-btn" style="padding:8px; font-size:1rem; background:#9e9e9e;">‚Üê Back to Home</button>
    </div>

    <!-- RIGHT: Maze Board -->
    <div>
      <div id="board" class="board"></div>
      <div class="footer-note" id="modeNote">Loading...</div>
    </div>
  </div>
</div>

<script>
// ==== Constants ====
const ACCOUNTS_KEY = 'maze_accounts_v8';
const SESSION_USER = 'maze_session_user';
const SESSION_GAME = 'maze_current_game';
const MAZE_PREFIX = 'maze_shared_maze_';
const GAME_INFO_PREFIX = 'maze_game_info_';
const EXIT_POS_PREFIX = 'maze_exit_pos_';
const PLAYER_POS_PREFIX = 'maze_player_pos_';

function getModeKey(gameCode, username) {
  return `maze_mode_${gameCode}_${username}`;
}

// ==== Auth ====
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function getAccounts() {
  const saved = localStorage.getItem(ACCOUNTS_KEY);
  return saved ? JSON.parse(saved) : {};
}
function saveAccounts(accounts) {
  localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts));
}
async function createAccount(username, password) {
  const accounts = getAccounts();
  if (accounts[username]) return false;
  const hash = await sha256(password);
  accounts[username] = hash;
  saveAccounts(accounts);
  return true;
}
async function login(username, password) {
  const accounts = getAccounts();
  if (!accounts[username]) return false;
  const hash = await sha256(password);
  return hash === accounts[username];
}
function setCurrentUser(username) { sessionStorage.setItem(SESSION_USER, username); }
function getCurrentUser() { return sessionStorage.getItem(SESSION_USER); }
function setCurrentGame(code) { sessionStorage.setItem(SESSION_GAME, code); }
function getCurrentGame() { return sessionStorage.getItem(SESSION_GAME); }
function clearCurrentGame() { sessionStorage.removeItem(SESSION_GAME); }
function logout() {
  sessionStorage.removeItem(SESSION_USER);
  sessionStorage.removeItem(SESSION_GAME);
}

// ==== Maze Generation ====
function generateRandomMaze(rows, cols) {
  const W = cols;
  const H = rows;
  const grid = Array.from({length:H}, () => Array.from({length:W}, () => '#'));
  for (let c = 0; c < W; c++) { grid[0][c] = '#'; grid[H-1][c] = '#'; }
  for (let r = 0; r < H; r++) { grid[r][0] = '#'; grid[r][W-1] = '#'; }

  function shuffle(arr) {
    const a = arr.slice();
    for(let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function carve(x,y){
    grid[y][x] = ' ';
    const dirs = shuffle([[2,0],[-2,0],[0,2],[0,-2]]);
    for(const d of dirs){
      const nx = x + d[0], ny = y + d[1];
      if(nx>0 && nx<W-1 && ny>0 && ny<H-1 && grid[ny][nx]==='#'){
        grid[y + d[1]/2][x + d[0]/2] = ' ';
        carve(nx, ny);
      }
    }
  }
  carve(2, 2);
  return grid;
}

// ==== Game Metadata ====
function saveGameInfo(gameCode, gameName, creator) {
  const key = GAME_INFO_PREFIX + gameCode;
  localStorage.setItem(key, JSON.stringify({ gameName, creator }));
}
function loadGameInfo(gameCode) {
  const key = GAME_INFO_PREFIX + gameCode;
  const infoStr = localStorage.getItem(key);
  if (!infoStr) return null;
  try {
    return JSON.parse(infoStr);
  } catch (e) {
    return null;
  }
}
function saveExitPosition(gameCode, pos) {
  localStorage.setItem(EXIT_POS_PREFIX + gameCode, JSON.stringify(pos));
}
function loadExitPosition(gameCode) {
  const str = localStorage.getItem(EXIT_POS_PREFIX + gameCode);
  if (!str) return null;
  try {
    return JSON.parse(str);
  } catch (e) {
    return null;
  }
}

// ==== Game Deletion ====
function deleteGame(gameCode, creator) {
  const user = getCurrentUser();
  if (user !== creator) return false;

  localStorage.removeItem(MAZE_PREFIX + gameCode);
  localStorage.removeItem(GAME_INFO_PREFIX + gameCode);
  localStorage.removeItem(EXIT_POS_PREFIX + gameCode);

  for (let key in localStorage) {
    if (key.startsWith(PLAYER_POS_PREFIX) && key.endsWith(`_${gameCode}`)) {
      localStorage.removeItem(key);
    }
  }

  if (getCurrentGame() === gameCode) {
    clearCurrentGame();
  }

  return true;
}

// ==== Leave Game ====
function leaveGame(gameCode, username) {
  const posKey = `${PLAYER_POS_PREFIX}${username}_${gameCode}`;
  localStorage.removeItem(posKey);
  clearCurrentGame();
  showScreen('homeScreen');
  refreshGameLibrary();
}

// ==== State ====
let currentUsername = null;
let maze = [];
let playerPos = [1, 1];
let moves = 0;
let gameCode = null;
let isCreator = false;
let currentMode = 'play';
let rows = 0, cols = 0;
let exitPos = null;

// DOM
const loginScreen = document.getElementById('loginScreen');
const createAccountScreen = document.getElementById('createAccountScreen');
const homeScreen = document.getElementById('homeScreen');
const gameScreen = document.getElementById('gameScreen');
const welcomeUser = document.getElementById('welcomeUser');
const createdGamesEl = document.getElementById('createdGames');
const joinedGamesEl = document.getElementById('joinedGames');
const boardEl = document.getElementById('board');
const logEl = document.getElementById('log');
const usernameDisplay = document.getElementById('usernameDisplay');
const gameCodeDisplay = document.getElementById('gameCodeDisplay');
const gameNameDisplay = document.getElementById('gameNameDisplay');
const modeToggleContainer = document.getElementById('modeToggleContainer');
const playControls = document.getElementById('playControls');
const modeNote = document.getElementById('modeNote');
const btnLeaveGame = document.getElementById('btnLeaveGame');
const controlsNote = document.getElementById('controlsNote');

// ==== Helpers ====
function getOpenCells() {
  const open = [];
  for (let r = 1; r < rows - 1; r++) {
    for (let c = 1; c < cols - 1; c++) {
      if (maze[r][c] !== '#') open.push([r, c]);
    }
  }
  return open;
}

function getRandomOpenCell(exclude = []) {
  const open = getOpenCells().filter(cell => 
    !exclude.some(e => e[0] === cell[0] && e[1] === cell[1])
  );
  if (open.length === 0) return [1,1];
  return open[Math.floor(Math.random() * open.length)];
}

function inBounds(r,c){ return r>=0 && r<rows && c>=0 && c<cols; }
function isWall(r,c){ return !inBounds(r,c) || maze[r][c]==='#'; }
function possibleMoves([r,c]) {
  const moves = {};
  if (!isWall(r-1,c)) moves.N = [r-1,c];
  if (!isWall(r+1,c)) moves.S = [r+1,c];
  if (!isWall(r,c-1)) moves.W = [r,c-1];
  if (!isWall(r,c+1)) moves.E = [r,c+1];
  return moves;
}

function getAllPlayerPositions() {
  const allPlayers = [];
  for (let key in localStorage) {
    if (key.startsWith(PLAYER_POS_PREFIX) && key.endsWith(`_${gameCode}`)) {
      const username = key.replace(PLAYER_POS_PREFIX, '').replace(`_${gameCode}`, '');
      try {
        const posStr = localStorage.getItem(key);
        if (posStr) {
          const pos = JSON.parse(posStr);
          allPlayers.push({
            username: username,
            pos: pos,
            isCurrent: username === currentUsername
          });
        }
      } catch (e) {}
    }
  }
  return allPlayers;
}

function savePlayerPosition() {
  if (!currentUsername || !gameCode) return;
  const key = `${PLAYER_POS_PREFIX}${currentUsername}_${gameCode}`;
  localStorage.setItem(key, JSON.stringify(playerPos));
}

function loadSharedMaze(gameCodeToLoad) {
  const mazeKey = MAZE_PREFIX + gameCodeToLoad;
  const mazeStr = localStorage.getItem(mazeKey);
  if (!mazeStr) return null;
  try {
    return JSON.parse(mazeStr);
  } catch (e) {
    return null;
  }
}

function saveSharedMaze() {
  if (!isCreator || !gameCode) return;
  const mazeKey = MAZE_PREFIX + gameCode;
  localStorage.setItem(mazeKey, JSON.stringify(maze));
}

// ==== Board Rendering ====
function renderBoard() {
  boardEl.innerHTML = '';

  const allPlayers = getAllPlayerPositions();

  if (currentMode === 'edit') {
    boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const div = document.createElement('div');
        div.className = 'cell';

        if (maze[r][c] === '#') {
          div.classList.add('wall');
        } else {
          div.classList.add('path');
        }

        allPlayers.forEach(p => {
          if (p.pos[0] === r && p.pos[1] === c) {
            const dot = document.createElement('div');
            dot.className = p.isCurrent ? 'player-you' : 'player-other';
            if (!p.isCurrent) dot.title = `Player: ${p.username}`;
            div.appendChild(dot);
          }
        });

        if (exitPos && exitPos[0] === r && exitPos[1] === c) {
          const exit = document.createElement('div');
          exit.className = 'exit';
          div.appendChild(exit);
        }

        if (isCreator) {
          div.addEventListener('click', () => {
            if (r === 0 || c === 0 || r === rows-1 || c === cols-1) return;
            if (!(exitPos && exitPos[0] === r && exitPos[1] === c)) {
              maze[r][c] = maze[r][c] === '#' ? ' ' : '#';
              saveSharedMaze();
              renderBoard();
            }
          });
        }

        boardEl.appendChild(div);
      }
    }
  } else {
    const [pr, pc] = playerPos;
    boardEl.style.gridTemplateColumns = `repeat(3, var(--cell-size))`;

    for (let dr = -1; dr <= 1; dr++) {
      for (let dc = -1; dc <= 1; dc++) {
        const r = pr + dr;
        const c = pc + dc;
        const div = document.createElement('div');
        div.className = 'cell';

        if (r < 0 || r >= rows || c < 0 || c >= cols) {
          div.classList.add('wall');
        } else {
          if (maze[r][c] === '#') {
            div.classList.add('wall');
          } else {
            div.classList.add('path');
          }

          const moves = possibleMoves(playerPos);
          for (const [dir, [mr, mc]] of Object.entries(moves)) {
            if (mr === r && mc === c) {
              div.classList.add('available');
            }
          }

          if (r === pr && c === pc) {
            allPlayers.forEach(p => {
              if (p.pos[0] === r && p.pos[1] === c) {
                const dot = document.createElement('div');
                dot.className = p.isCurrent ? 'player-you' : 'player-other';
                if (!p.isCurrent) dot.title = `Player: ${p.username}`;
                div.appendChild(dot);
              }
            });

            if (exitPos && exitPos[0] === r && exitPos[1] === c) {
              const exit = document.createElement('div');
              exit.className = 'exit';
              div.appendChild(exit);
            }
          }
        }

        boardEl.appendChild(div);
      }
    }

    const dirs = possibleMoves(playerPos);
    document.getElementById('north').disabled = !dirs.N;
    document.getElementById('south').disabled = !dirs.S;
    document.getElementById('west').disabled  = !dirs.W;
    document.getElementById('east').disabled  = !dirs.E;
  }
}

// ==== UI ====
function updateModeUI() {
  modeToggleContainer.innerHTML = '';

  if (isCreator) {
    const btn = document.createElement('button');
    btn.className = currentMode === 'edit' ? 'mode-toggle edit' : 'mode-toggle play';
    btn.textContent = currentMode === 'edit' ? 'Switch to Play Mode' : 'Switch to Edit Mode';
    btn.addEventListener('click', () => {
      currentMode = currentMode === 'edit' ? 'play' : 'edit';
      localStorage.setItem(getModeKey(gameCode, currentUsername), currentMode);
      updateModeNote();
      renderBoard();
    });
    modeToggleContainer.appendChild(btn);
  }

  playControls.style.display = 'block';
  controlsNote.textContent = currentMode === 'edit' 
    ? 'Edit Mode: click walls to toggle. Use arrows to move.' 
    : 'Play Mode: only 3√ó3 visible. Exit/players visible only on your cell.';

  updateModeNote();

  btnLeaveGame.style.display = isCreator ? 'none' : 'block';
}

function updateModeNote() {
  modeNote.textContent = currentMode === 'edit'
    ? 'Edit Mode: click to edit walls. All players and exit shown.'
    : 'Play Mode: only 3√ó3 visible. Exit/players visible only on your cell.';
}

function showScreen(screenId) {
  loginScreen.classList.add('hidden');
  createAccountScreen.classList.add('hidden');
  homeScreen.classList.add('hidden');
  gameScreen.classList.add('hidden');
  document.getElementById(screenId).classList.remove('hidden');
  sessionStorage.setItem('maze_current_screen', screenId);
}

function log(msg) {
  const el = document.createElement('div');
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logEl.prepend(el);
}
function logClear() { logEl.innerHTML = ''; }

// ==== Movement ====
function move(dir) {
  const movesMap = possibleMoves(playerPos);
  if (!movesMap[dir]) {
    log("You can't go that way.");
    return;
  }

  playerPos = movesMap[dir].slice();
  savePlayerPosition();
  if (currentMode === 'play') {
    moves++;
    log(`Moved ${dir}.`);
  }
  renderBoard();
  if (currentMode === 'play') {
    checkWin();
  }
}

function checkWin() {
  if (exitPos && playerPos[0] === exitPos[0] && playerPos[1] === exitPos[1]) {
    log(`üéâ You found the exit in ${moves} moves!`);
    alert(`üéâ You found the exit in ${moves} moves!`);
  }
}

// ==== Game Flow ====
function createNewGame() {
  const gameNameInput = document.getElementById('gameNameInput');
  const gameName = gameNameInput.value.trim() || `Maze`;
  const size = parseInt(document.getElementById('mazeSizeSelect').value);
  maze = generateRandomMaze(size, size);
  rows = maze.length;
  cols = maze[0].length;

  const openCells = getOpenCells();
  exitPos = openCells[Math.floor(Math.random() * openCells.length)];
  playerPos = getRandomOpenCell([exitPos]);
  moves = 0;
  gameCode = Math.random().toString(36).substr(2,8).toUpperCase();
  isCreator = true;
  currentMode = 'edit';

  saveSharedMaze();
  savePlayerPosition();
  saveGameInfo(gameCode, gameName, currentUsername);
  saveExitPosition(gameCode, exitPos);
  setCurrentGame(gameCode);
  localStorage.setItem(getModeKey(gameCode, currentUsername), currentMode);

  showScreen('gameScreen');
  gameNameDisplay.textContent = gameName;
  gameCodeDisplay.textContent = gameCode;
  usernameDisplay.textContent = currentUsername;
  updateModeUI();
  renderBoard();
  logClear();
  log(`‚úÖ Created game "${gameName}" (${gameCode})`);
}

function joinGame(code) {
  if (!code.trim()) {
    alert("Please enter a game code.");
    return;
  }
  const gameCodeToJoin = code.trim().toUpperCase();
  const sharedMaze = loadSharedMaze(gameCodeToJoin);
  if (!sharedMaze) {
    alert(`Game "${gameCodeToJoin}" does not exist.`);
    return;
  }

  maze = sharedMaze;
  rows = maze.length;
  cols = maze[0].length;
  exitPos = loadExitPosition(gameCodeToJoin);

  const posKey = `${PLAYER_POS_PREFIX}${currentUsername}_${gameCodeToJoin}`;
  let posStr = localStorage.getItem(posKey);
  if (posStr) {
    playerPos = JSON.parse(posStr);
  } else {
    const existingPositions = getAllPlayerPositions().map(p => p.pos);
    const exclude = exitPos ? [...existingPositions, exitPos] : existingPositions;
    playerPos = getRandomOpenCell(exclude);
    localStorage.setItem(posKey, JSON.stringify(playerPos));
  }

  moves = 0;
  gameCode = gameCodeToJoin;
  const gameInfo = loadGameInfo(gameCode);
  isCreator = gameInfo?.creator === currentUsername;

  const savedMode = localStorage.getItem(getModeKey(gameCode, currentUsername));
  currentMode = isCreator && savedMode ? savedMode : 'play';

  setCurrentGame(gameCode);
  savePlayerPosition();

  const displayName = gameInfo?.gameName || `Maze ${gameCode}`;

  showScreen('gameScreen');
  gameNameDisplay.textContent = displayName;
  gameCodeDisplay.textContent = gameCode;
  usernameDisplay.textContent = currentUsername;
  updateModeUI();
  renderBoard();
  logClear();
  log(`‚úÖ Joined game: ${gameCodeToJoin}`);
}

// ==== Game Library ====
function refreshGameLibrary() {
  createdGamesEl.innerHTML = '';
  joinedGamesEl.innerHTML = '';
  const user = getCurrentUser();
  if (!user) return;

  const createdGames = new Set();
  const joinedGames = new Set();

  for (let key in localStorage) {
    if (key.startsWith(`${PLAYER_POS_PREFIX}${user}_`)) {
      const code = key.replace(`${PLAYER_POS_PREFIX}${user}_`, '');
      const info = loadGameInfo(code);
      if (info && info.creator === user) {
        createdGames.add(code);
      } else {
        joinedGames.add(code);
      }
    }
  }

  if (createdGames.size === 0) {
    createdGamesEl.textContent = 'None';
  } else {
    createdGames.forEach(code => {
      const gameInfo = loadGameInfo(code);
      const name = gameInfo?.gameName || `Maze ${code}`;
      const container = document.createElement('div');
      container.style.margin = '6px 0';

      const btn = document.createElement('button');
      btn.className = 'home-btn';
      btn.style.fontSize = '0.95rem';
      btn.style.padding = '8px 12px';
      btn.textContent = `${name} (${code})`;
      btn.onclick = () => joinGame(code);
      container.appendChild(btn);

      const delBtn = document.createElement('button');
      delBtn.className = 'home-btn delete';
      delBtn.style.fontSize = '0.85rem';
      delBtn.style.padding = '4px 8px';
      delBtn.style.marginLeft = '6px';
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.onclick = () => {
        if (confirm(`Delete game "${name}" (${code})? This cannot be undone.`)) {
          deleteGame(code, user);
          refreshGameLibrary();
        }
      };
      container.appendChild(delBtn);

      createdGamesEl.appendChild(container);
    });
  }

  if (joinedGames.size === 0) {
    joinedGamesEl.textContent = 'None';
  } else {
    joinedGames.forEach(code => {
      const gameInfo = loadGameInfo(code);
      const name = gameInfo?.gameName || `Maze ${code}`;
      const container = document.createElement('div');
      container.style.margin = '6px 0';

      const btn = document.createElement('button');
      btn.className = 'home-btn';
      btn.style.fontSize = '0.95rem';
      btn.style.padding = '8px 12px';
      btn.textContent = `${name} (${code})`;
      btn.onclick = () => joinGame(code);
      container.appendChild(btn);

      if (!gameInfo || gameInfo.creator !== user) {
        const leaveBtn = document.createElement('button');
        leaveBtn.className = 'home-btn leave';
        leaveBtn.style.fontSize = '0.85rem';
        leaveBtn.style.padding = '4px 8px';
        leaveBtn.style.marginLeft = '6px';
        leaveBtn.textContent = 'üö™ Leave';
        leaveBtn.onclick = () => {
          if (confirm(`Leave game "${name}"? Your progress will be removed.`)) {
            leaveGame(code, user);
          }
        };
        container.appendChild(leaveBtn);
      }

      joinedGamesEl.appendChild(container);
    });
  }
}

// ==== Event Listeners ====
document.getElementById('btnLogin').addEventListener('click', async () => {
  const user = document.getElementById('loginUsername').value.trim();
  const pass = document.getElementById('loginPassword').value;
  const err = document.getElementById('loginError');
  err.textContent = '';
  if (await login(user, pass)) {
    currentUsername = user;
    setCurrentUser(user);
    showScreen('homeScreen');
    welcomeUser.textContent = user;
    refreshGameLibrary();
  } else {
    err.textContent = "Invalid username or password.";
  }
});

document.getElementById('btnCreateAccount').addEventListener('click', () => {
  showScreen('createAccountScreen');
});

document.getElementById('btnBackToLogin').addEventListener('click', () => {
  showScreen('loginScreen');
});

document.getElementById('btnSubmitCreate').addEventListener('click', async () => {
  const user = document.getElementById('newUsername').value.trim();
  const pass = document.getElementById('newPassword').value;
  const confirm = document.getElementById('confirmPassword').value;
  const err = document.getElementById('createError');
  err.textContent = '';

  if (!user || user.length < 3) {
    err.textContent = "Username must be at least 3 characters.";
    return;
  }
  if (pass.length < 4) {
    err.textContent = "Password must be at least 4 characters.";
    return;
  }
  if (pass !== confirm) {
    err.textContent = "Passwords do not match.";
    return;
  }

  if (await createAccount(user, pass)) {
    currentUsername = user;
    setCurrentUser(user);
    showScreen('homeScreen');
    welcomeUser.textContent = user;
    refreshGameLibrary();
  } else {
    err.textContent = "Username already exists.";
  }
});

document.getElementById('btnCreateHome').addEventListener('click', createNewGame);
document.getElementById('btnJoinHome').addEventListener('click', () => {
  joinGame(document.getElementById('homeGameCode').value);
});
document.getElementById('btnLogoutHome').addEventListener('click', () => {
  logout();
  showScreen('loginScreen');
});

document.getElementById('btnBackToHome').addEventListener('click', () => {
  showScreen('homeScreen');
  refreshGameLibrary();
});

document.getElementById('btnLeaveGame').addEventListener('click', () => {
  if (confirm(`Leave this game? Your position will be removed.`)) {
    leaveGame(gameCode, currentUsername);
  }
});

['north','south','west','east'].forEach(dir => {
  document.getElementById(dir).addEventListener('click', () => {
    move(dir.toUpperCase()[0]);
  });
});

window.addEventListener('keydown', (e) => {
  if (gameScreen.classList.contains('hidden')) return;
  const keyMap = {ArrowUp:'N', ArrowDown:'S', ArrowLeft:'W', ArrowRight:'E'};
  if (keyMap[e.key]) move(keyMap[e.key]);
});

window.addEventListener('storage', (e) => {
  if (e.key && e.key.startsWith(PLAYER_POS_PREFIX) && e.key.endsWith(`_${gameCode}`)) {
    setTimeout(renderBoard, 50);
  }
});

// ==== Strict Page-State Resume ====
window.addEventListener('load', () => {
  const user = getCurrentUser();
  const savedGameCode = getCurrentGame();
  const lastScreen = sessionStorage.getItem('maze_current_screen');

  if (user && savedGameCode && lastScreen === 'gameScreen') {
    const sharedMaze = loadSharedMaze(savedGameCode);
    const exit = loadExitPosition(savedGameCode);
    const gameInfo = loadGameInfo(savedGameCode);
    if (sharedMaze && exit && gameInfo) {
      maze = sharedMaze;
      exitPos = exit;
      rows = maze.length;
      cols = maze[0].length;
      currentUsername = user;
      isCreator = gameInfo.creator === user;

      // ‚úÖ FIXED: Set gameCode BEFORE calling renderBoard()
      gameCode = savedGameCode;

      const posKey = `${PLAYER_POS_PREFIX}${user}_${gameCode}`;
      const posStr = localStorage.getItem(posKey);
      playerPos = posStr ? JSON.parse(posStr) : [1,1];

      const savedMode = localStorage.getItem(getModeKey(gameCode, user));
      currentMode = isCreator && savedMode ? savedMode : (isCreator ? 'edit' : 'play');

      showScreen('gameScreen');
      gameNameDisplay.textContent = gameInfo.gameName || `Maze ${gameCode}`;
      gameCodeDisplay.textContent = gameCode;
      usernameDisplay.textContent = user;
      updateModeUI();
      renderBoard();
      logClear();
      log("üîÑ Resumed game after refresh.");
      return;
    }
  }

  if (user) {
    currentUsername = user;
    showScreen('homeScreen');
    welcomeUser.textContent = user;
    refreshGameLibrary();
    return;
  }

  showScreen('loginScreen');
});
</script>
</body>
</html>
